# ============================================
# Debezium Server Configuration
# Oracle CDC to Azure Event Hubs
# ============================================

# ============================================
# Source: Oracle Database Configuration
# ============================================
debezium.source.connector.class=io.debezium.connector.oracle.OracleConnector
debezium.source.database.hostname=oracle
debezium.source.database.port=1521
debezium.source.database.user=c##cdcuser
debezium.source.database.password=CdcPassword123
debezium.source.database.dbname=XE
debezium.source.database.pdb.name=XEPDB1

# Server name for topic naming
debezium.source.topic.prefix=oracle

# ============================================
# Snapshot Configuration
# ============================================
# schema_only: Do NOT snapshot existing data, only capture schema => no_data
# subsequent changes will be captured from now on
debezium.source.snapshot.mode=no_data

# Don't lock tables during snapshot
debezium.source.snapshot.locking.mode=none

# ============================================
# LogMiner Configuration
# ============================================
# Use online catalog for better performance: redo_log_catalog, online_catalog, hybrid
debezium.source.log.mining.strategy=online_catalog

# Continuous mining for real-time CDC
# debezium.source.log.mining.continuous.mine=true
debezium.source.log.mining.continuous.mine=false

# Archive log retention hours
debezium.source.archive.log.hours=48

# LogMiner batch settings for performance
debezium.source.log.mining.batch.size.default=20000
debezium.source.log.mining.batch.size.min=1000
debezium.source.log.mining.batch.size.max=100000

# LogMiner sleep time (ms)
debezium.source.log.mining.sleep.time.default.ms=1000
debezium.source.log.mining.sleep.time.min.ms=0
debezium.source.log.mining.sleep.time.max.ms=3000

# Transaction retention
debezium.source.log.mining.transaction.retention.ms=0

# ============================================
# Table Selection
# ============================================
# Include only specific tables
debezium.source.table.include.list=DATAUSER.CUSTOMERS,DATAUSER.ORDERS

# Schema changes tracking
debezium.source.include.schema.changes=false

# ============================================
# Data Type Mapping (Best Practices)
# ============================================
# Decimal handling: string
debezium.source.decimal.handling.mode=double
# debezium.source.decimal.handling.mode=precise

# Time precision: adaptive_time_microseconds for high precision
# debezium.source.time.precision.mode=adaptive_time_microseconds
debezium.source.time.precision.mode=isostring

# Binary data handling
debezium.source.binary.handling.mode=bytes

# Interval handling
debezium.source.interval.handling.mode=string

# LOB handling: disabled for better performance
debezium.source.lob.enabled=false

# ============================================
# Event Configuration
# ============================================
# Tombstone events on delete
debezium.source.tombstones.on.delete=true

# Skipped operations (empty = capture all)
# debezium.source.skipped.operations=t

# Provide transaction metadata
debezium.source.provide.transaction.metadata=false

# ============================================
# Performance Tuning
# ============================================
debezium.source.max.batch.size=2048
debezium.source.max.queue.size=8192
debezium.source.poll.interval.ms=1000

# ============================================
# Heartbeat Configuration
# ============================================
# debezium.source.heartbeat.interval.ms=60000
# debezium.source.heartbeat.topics.prefix=__debezium-heartbeat

# ============================================
# Error Handling
# ============================================
# debezium.source.errors.tolerance=all
debezium.source.errors.tolerance=none
debezium.source.errors.log.enable=true
debezium.source.errors.log.include.messages=true
debezium.source.event.processing.failure.handling.mode=fail
# debezium.source.event.processing.failure.handling.mode=warn

# Add error handling for missing logs
debezium.source.errors.max.retries=5
debezium.source.errors.retry.delay.initial.ms=1000
debezium.source.errors.retry.delay.max.ms=30000

# ============================================
# Sink: Azure Event Hubs Configuration
# ============================================
debezium.sink.type=eventhubs

# Event Hub name (required)
debezium.sink.eventhubs.hubname=${ORACLE_EVENTHUB_NAME}

# Connection string - uses env variable ORACLE_EVENTHUBS_CONNECTION_STRING if set,
# otherwise composes from individual components
debezium.sink.eventhubs.connectionstring=${ORACLE_EVENTHUBS_CONNECTION_STRING:Endpoint=sb://${AZURE_EVENTHUB_NAMESPACE}.servicebus.windows.net;SharedAccessKeyName=${SAS_KEY_NAME};SharedAccessKey=${SAS_KEY};EntityPath=${ORACLE_EVENTHUB_NAME}}

# Maximum retries
debezium.sink.eventhubs.max.retries=10

# Retry backoff (ms)
debezium.sink.eventhubs.retry.backoff.ms=3000

# Hash message key to distribute load
debezium.sink.eventhubs.hashmessagekey=true
debezium.sink.eventhubs.hashmessagekeyfunction=java

# ============================================
# Format Configuration
# ============================================
# Format: json or avro (set in .env file via DATA_FORMAT)
# debezium.format.key=json
debezium.format.value=json

# Schema behavior
debezium.format.schemas.enable=false
debezium.format.json.schemas.enable=false

# ============================================
# AVRO Format Configuration
# ============================================
# Use Apicurio (built-in)
# debezium.format.key.serializer=io.apicurio.registry.serde.avro.AvroKafkaSerializer
# debezium.format.value.serializer=io.apicurio.registry.serde.avro.AvroKafkaSerializer

# debezium.format.key.apicurio.registry.url=${SCHEMA_REGISTRY_URL}
# debezium.format.value.apicurio.registry.url=${SCHEMA_REGISTRY_URL}

# ============================================
# Offset Storage Configuration
# ============================================
# File-based offset storage (for stop/restart capability)
debezium.source.offset.storage=org.apache.kafka.connect.storage.FileOffsetBackingStore
debezium.source.offset.storage.file.filename=/debezium/data/offsets.dat
debezium.source.offset.flush.interval.ms=10000

# ============================================
# Schema History Storage
# ============================================
# File-based schema history storage
debezium.source.schema.history.internal=io.debezium.storage.file.history.FileSchemaHistory
debezium.source.schema.history.internal.file.filename=/debezium/data/schema-history.dat
debezium.source.schema.history.internal.skip.unparseable.ddl=true

# ============================================
# Transforms (Optional)
# ============================================
# Uncomment to flatten nested structures
# debezium.transforms=unwrap
debezium.transforms=unwrap,hoist

debezium.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState
debezium.transforms.unwrap.drop.tombstones=false
debezium.transforms.unwrap.delete.tombstone.handling.mode=rewrite
debezium.transforms.unwrap.add.fields=op,ts_ns,source.ts_ns,source.db,source.schema,source.table,source.scn

debezium.transforms.hoist.type=org.apache.kafka.connect.transforms.HoistField$Value
debezium.transforms.hoist.field=data

# ============================================
# Logging
# ============================================
quarkus.log.level=INFO
quarkus.log.console.level=INFO
quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n

# Debezium logging
quarkus.log.category."io.debezium".level=INFO
quarkus.log.category."io.debezium.connector.oracle".level=INFO
quarkus.log.category."io.debezium.relational".level=INFO

# ============================================
# HTTP Health Check (Optional)
# ============================================
quarkus.http.port=8080
quarkus.http.host=0.0.0.0

# ============================================
# Notes
# ============================================
# 1. Replace Azure Event Hubs connection string with your actual credentials
# 2. Ensure Oracle is in ARCHIVELOG mode (see SETUP_GUIDE.md)
# 3. Ensure supplemental logging is enabled (see SETUP_GUIDE.md)
# 4. Offset storage allows connector to resume from last position on restart
# 5. Schema history tracks database schema changes over time
