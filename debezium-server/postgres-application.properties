# ============================================
# Debezium Server Configuration
# PostgreSQL CDC to Azure Event Hubs
# ============================================

# ============================================
# Source: PostgreSQL Database Configuration
# ============================================
debezium.source.connector.class=io.debezium.connector.postgresql.PostgresConnector
debezium.source.database.hostname=postgres
debezium.source.database.port=5432
debezium.source.database.user=cdcuser
debezium.source.database.password=CdcPassword123
debezium.source.database.dbname=cdcdb

# Server name for topic naming
debezium.source.topic.prefix=postgres

# Plugin for logical decoding
debezium.source.plugin.name=pgoutput

# Publication name (created in postgres-init.sql)
debezium.source.publication.name=dbz_publication

# Replication slot name (will be auto-created)
debezium.source.slot.name=debezium_slot

# ============================================
# Snapshot Configuration
# ============================================
# never: Do NOT snapshot existing data, only capture changes from now => no_data
debezium.source.snapshot.mode=no_data

# Alternative modes:
# initial: Take initial snapshot then stream changes
# always: Always take snapshot on start
# never: Skip snapshot, start from current position

# ============================================
# Table Selection
# ============================================
# Include only specific tables (updated to datauser schema)
debezium.source.table.include.list=datauser.products,datauser.inventory_transactions

# Schema changes tracking
debezium.source.include.schema.changes=false

# ============================================
# Data Type Mapping (Best Practices)
# ============================================
# Decimal handling: string
debezium.source.decimal.handling.mode=double
# debezium.source.decimal.handling.mode=precise

# Time precision: adaptive_time_microseconds for high precision
# debezium.source.time.precision.mode=adaptive_time_microseconds
debezium.source.time.precision.mode=isostring

# Binary data handling
debezium.source.binary.handling.mode=bytes

# Interval handling
debezium.source.interval.handling.mode=string

# HStore handling
debezium.source.hstore.handling.mode=json

# ============================================
# Event Configuration
# ============================================
# Tombstone events on delete
debezium.source.tombstones.on.delete=true

# Skipped operations (empty = capture all)
# debezium.source.skipped.operations=t

# Provide transaction metadata
debezium.source.provide.transaction.metadata=false

# ============================================
# Performance Tuning
# ============================================
debezium.source.max.batch.size=2048
debezium.source.max.queue.size=8192
debezium.source.poll.interval.ms=1000

# ============================================
# Heartbeat Configuration
# ============================================
# debezium.source.heartbeat.interval.ms=60000
# debezium.source.heartbeat.topics.prefix=__debezium-heartbeat

# ============================================
# Error Handling
# ============================================
# debezium.source.errors.tolerance=all
debezium.source.errors.tolerance=none
debezium.source.errors.log.enable=true
debezium.source.errors.log.include.messages=true
debezium.source.event.processing.failure.handling.mode=fail
# debezium.source.event.processing.failure.handling.mode=warn

# Add error handling for missing logs
debezium.source.errors.max.retries=5
debezium.source.errors.retry.delay.initial.ms=1000
debezium.source.errors.retry.delay.max.ms=30000

# ============================================
# Sink: Azure Event Hubs Configuration
# ============================================
debezium.sink.type=eventhubs

# Event Hub name (required)
debezium.sink.eventhubs.hubname=${POSTGRES_EVENTHUB_NAME}

# Connection string - uses env variable POSTGRES_EVENTHUBS_CONNECTION_STRING if set,
# otherwise composes from individual components
debezium.sink.eventhubs.connectionstring=${POSTGRES_EVENTHUBS_CONNECTION_STRING:Endpoint=sb://${AZURE_EVENTHUB_NAMESPACE}.servicebus.windows.net;SharedAccessKeyName=${SAS_KEY_NAME};SharedAccessKey=${SAS_KEY};EntityPath=${POSTGRES_EVENTHUB_NAME}}

# Maximum retries
debezium.sink.eventhubs.max.retries=10

# Retry backoff (ms)
debezium.sink.eventhubs.retry.backoff.ms=3000

# Hash message key to distribute load
debezium.sink.eventhubs.hashmessagekey=true
debezium.sink.eventhubs.hashmessagekeyfunction=java

# ============================================
# Format Configuration
# ============================================
# Format: json, avro, or cloudevents (set in .env file via DATA_FORMAT)
# debezium.format.key=json
debezium.format.value=${DATA_FORMAT:json}

# Schema behavior
debezium.format.schemas.enable=${JSON_SCHEMAS_ENABLE:false}
# debezium.format.schemas.enable=false

# ============================================
# CloudEvents Format Configuration
# ============================================
# CloudEvents is a CNCF specification for describing event data in a common way
# To use CloudEvents format, set DATA_FORMAT=cloudevents in .env file
#
# CloudEvents converter adds standard attributes:
# - id: unique identifier for the event
# - source: source of the event (topic name)
# - specversion: CloudEvents spec version (1.0)
# - type: event type (e.g., "io.debezium.connector.postgresql.datachangeevent")
# - datacontenttype: content type (e.g., "application/json")
# - time: event timestamp
# - data: the actual Debezium event payload
#
# CloudEvents source name (optional custom source identifier)
debezium.format.cloudevents.source.name=${CLOUDEVENTS_SOURCE_NAME:}
# debezium.format.cloudevents.source.name=postgres-cdc-system
#
# Schema reference in CloudEvents (optional)
debezium.format.cloudevents.schema.name.adjustment.mode=${CLOUDEVENTS_SCHEMA_NAME_ADJUSTMENT:none}
# Options: none, avro
#
# Data serialization format (what goes inside the CloudEvents 'data' field)
debezium.format.cloudevents.data.serializer.type=${CLOUDEVENTS_DATA_SERIALIZER:json}
# Options: json, avro

# ============================================
# AVRO Format Configuration
# ============================================
# Use Apicurio (built-in)
# debezium.format.key.serializer=io.apicurio.registry.serde.avro.AvroKafkaSerializer
# debezium.format.value.serializer=io.apicurio.registry.serde.avro.AvroKafkaSerializer

# debezium.format.key.apicurio.registry.url=${SCHEMA_REGISTRY_URL}
# debezium.format.value.apicurio.registry.url=${SCHEMA_REGISTRY_URL}

# ============================================
# Offset Storage Configuration
# ============================================
# File-based offset storage (for stop/restart capability)
debezium.source.offset.storage=org.apache.kafka.connect.storage.FileOffsetBackingStore
debezium.source.offset.storage.file.filename=/debezium/data/offsets.dat
debezium.source.offset.flush.interval.ms=10000

# ============================================
# Schema History Storage
# ============================================
# File-based schema history storage
debezium.source.schema.history.internal=io.debezium.storage.file.history.FileSchemaHistory
debezium.source.schema.history.internal.file.filename=/debezium/data/schema-history.dat
debezium.source.schema.history.internal.skip.unparseable.ddl=true

# ============================================
# Transforms (Optional)
# ============================================
# Uncomment to flatten nested structures
debezium.transforms=unwrap
debezium.transforms.unwrap.type=io.debezium.transforms.ExtractNewRecordState
debezium.transforms.unwrap.drop.tombstones=false
debezium.transforms.unwrap.delete.tombstone.handling.mode=rewrite
debezium.transforms.unwrap.add.fields=op,ts_ns,source.ts_ns,source.db,source.schema,source.table,source.lsn

# ============================================
# Logging
# ============================================W
quarkus.log.level=INFO
quarkus.log.console.level=INFO
quarkus.log.console.format=%d{HH:mm:ss} %-5p [%c{2.}] (%t) %s%e%n

# Debezium logging
quarkus.log.category."io.debezium".level=INFO
quarkus.log.category."io.debezium.connector.postgresql".level=INFO
quarkus.log.category."io.debezium.relational".level=INFO

# ============================================
# HTTP Health Check (Optional)
# ============================================
quarkus.http.port=8081
quarkus.http.host=0.0.0.0

# ============================================
# Notes
# ============================================
# 1. Replace Azure Event Hubs connection string with your actual credentials
# 2. Ensure PostgreSQL is configured with wal_level=logical
# 3. Ensure publication 'dbz_publication' exists
# 4. Offset storage allows connector to resume from last position on restart
# 5. Schema history tracks database schema changes over time
# 6. Replication slot will be auto-created by Debezium
